variables:
  REPO_NAME: gitlab.com/namespace/project

stages:
  - apply
  - test
  - docker
  - deploy

test_app:
    before_script:
      - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
      - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
      - cd $GOPATH/src/$REPO_NAME
      - go get github.com/Masterminds/glide
      - glide install
    image: golang:latest
    stage: test
    script:
      - go test

build_image:
    image: docker:latest
    services:
      - docker:dind
    stage: docker
    script:
      - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD" registry.gitlab.com
      - docker build -t registry.gitlab.com/etiennecoutaud1/go-demo:$CI_COMMIT_SHA .
      - docker push registry.gitlab.com/etiennecoutaud1/go-demo:$CI_COMMIT_SHA

deploy_feature_branch:
  stage: deploy
  script:
    - echo "Deploy to CI_BUILD_REF_NAME server"
  environment:
    name: $CI_BUILD_REF_NAME
    url: https://CI_BUILD_REF_NAME.example.com
  only:
  - /^fb-.*/@etiennecoutaud1/go-demo

deploy_dev:
  stage: deploy
  script:
    - echo "Deploy to dev server"
  environment:
    name: dev
    url: https://dev.example.com
  only:
  - master

deploy_prod:
  stage: deploy
  script:
    - echo "Deploy to prod server"
  environment:
    name: prod
    url: https://prod.example.com
  only:
  - /^release-.*/@etiennecoutaud1/go-demo

apply_config:
  stage: apply
  script:
    - echo "Apply"
  only:
  - paths: "/manifests"

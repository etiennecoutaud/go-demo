variables:
  REPO_NAME: gitlab.com/namespace/project

stages:
  - test
  - docker

test_app:
    before_script:
      - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
      - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
      - cd $GOPATH/src/$REPO_NAME
      - go get github.com/Masterminds/glide
      - glide install
    image: golang:latest
    stage: test
    script:
      - go test

build_image:
    image: docker:latest
    services:
      - docker:dind
    stage: docker
    script:
      - docker login registry.gitlab.com -u $DOCKER_LOGIN -p DOCKER_TOKEN
      - docker build -t registry.gitlab.com/etiennecoutaud1/go-demo .
      - docker push registry.gitlab.com/etiennecoutaud1/go-demo
